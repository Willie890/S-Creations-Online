<script>
    // ========================
    // ADMIN DASHBOARD SCRIPT
    // ========================

    const API_BASE = 'https://s-creations-online.onrender.com/api';

    // Function to check if the user is authenticated (relies on the HttpOnly cookie)
    async function checkAdminAuth() {
        try {
            // Check current user status (assuming /auth/me is protected)
            const res = await fetch(`${API_BASE}/auth/me`, {
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include' // Send the HttpOnly cookie
            });
            
            if (!res.ok) {
                throw new Error('Unauthorized or not an admin.');
            }
            const data = await res.json();
            if (data.role !== 'admin') {
                throw new Error('Not an admin.');
            }
            return data;
        } catch (err) {
            console.error(err.message);
            alert('You must be logged in as admin to access this page.');
            // Fallback clear and redirect
            document.cookie = 'token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
            window.location.href = '/login.html';
        }
    }

    // Run check on load
    checkAdminAuth();

    // Logout function (MODIFIED to rely on backend to clear HttpOnly cookie)
    document.getElementById('logout-btn').addEventListener('click', async () => {
        try {
            // Assuming there is a logout route that clears the cookie
            await fetch(`${API_BASE}/auth/logout`, { method: 'POST', credentials: 'include' });
        } catch (e) {
            console.error('Logout failed:', e);
        }
        document.cookie = 'token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
        window.location.href = '/';
    });

    // Tab switching (UNMODIFIED)
    document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('admin-tab--active'));
            document.querySelectorAll('.admin-content').forEach(c => c.classList.remove('admin-content--active'));
            tab.classList.add('admin-tab--active');
            document.getElementById(`tab-${tab.dataset.tab}`).classList.add('admin-content--active');
        });
    });

    // Load products (MODIFIED: relies on HttpOnly cookie)
    async function loadProducts() {
        try {
            const res = await fetch(`${API_BASE}/products`, { credentials: 'include' }); 
            if (!res.ok) throw new Error('Failed to load products');
            const products = await res.json();
            renderProducts(products);
        } catch (err) {
            console.error('Error loading products:', err);
            document.getElementById('product-list').innerHTML = '<p>Error loading products.</p>';
        }
    }

    // Render products (UNMODIFIED)
    function renderProducts(products) {
        const container = document.getElementById('product-list');
        if (!container) return;

        if (!products.length) {
            container.innerHTML = '<p>No products found.</p>';
            return;
        }

        container.innerHTML = products.map(p => `
            <div class="product-card">
              <div class="product-image">
                <img src="${p.image || 'https://via.placeholder.com/300x200?text=No+Image'}" alt="${p.name}" />
              </div>
              <div class="product-info">
                <h3 class="product-title">${p.name}</h3>
                <p class="product-price">$${p.price}</p>
                <div class="product-actions">
                  <button class="btn-edit" onclick="editProduct('${p._id}')">Edit</button>
                  <button class="btn-delete" onclick="deleteProduct('${p._id}')">Delete</button>
                </div>
              </div>
            </div>
        `).join('');
    }

    // Add product (MODIFIED: relies on HttpOnly cookie)
    document.getElementById('add-product-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('product-name').value;
        const description = document.getElementById('product-description').value;
        const price = parseFloat(document.getElementById('product-price').value);
        const category = document.getElementById('product-category').value;
        const image = document.getElementById('product-image').value;
        const badge = document.getElementById('product-badge').value;

        try {
            const res = await fetch(`${API_BASE}/products`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ name, description, price, category, image, badge })
            });
            if (!res.ok) throw new Error('Failed to add product');
            alert('✅ Product added successfully!');
            loadProducts(); // Refresh list
            document.getElementById('add-product-form').reset();
        } catch (err) {
            alert('❌ Failed to add product: ' + err.message);
        }
    });

    // Edit product (placeholder - UNMODIFIED)
    function editProduct(id) {
        alert('Edit functionality coming soon. In production, this would open a form to edit the product.');
    }

    // Delete product (MODIFIED: relies on HttpOnly cookie)
    async function deleteProduct(id) {
        if (!confirm('Are you sure you want to delete this product?')) return;

        try {
            const res = await fetch(`${API_BASE}/products/${id}`, {
                method: 'DELETE',
                credentials: 'include' // Send the HttpOnly cookie
            });
            if (!res.ok) throw new Error('Failed to delete product');
            alert('✅ Product deleted!');
            loadProducts(); // Refresh list
        } catch (err) {
            alert('❌ Failed to delete product: ' + err.message);
        }
    }

    // Load categories (MODIFIED: relies on HttpOnly cookie)
    async function loadCategories() {
        try {
            const res = await fetch(`${API_BASE}/products/categories`, { credentials: 'include' });
            if (!res.ok) throw new Error('Failed to load categories');
            const categories = await res.json();
            renderCategories(categories);
        } catch (err) {
            console.error('Error loading categories:', err);
            document.getElementById('category-list').innerHTML = '<p>Error loading categories.</p>';
        }
    }

    // Render categories (UNMODIFIED)
    function renderCategories(categories) {
        const container = document.getElementById('category-list');
        if (!container) return;

        if (!categories.length) {
            container.innerHTML = '<p>No categories found.</p>';
            return;
        }

        container.innerHTML = categories.map(cat => `
            <div style="padding: 1rem; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--border-radius-md); margin: 0.5rem 0;">
              <span>${cat}</span>
            </div>
        `).join('');
    }

    // Load users (MODIFIED: Updated API call to new /api/users route)
    async function loadUsers() {
        try {
            // Get current user info (needed for 'Self' tag)
            const resMe = await fetch(`${API_BASE}/auth/me`, { credentials: 'include' });
            if (!resMe.ok) throw new Error('Failed to load current user info');
            const currentUser = await resMe.json();

            // Get all users
            const resAll = await fetch(`${API_BASE}/users`, { credentials: 'include' });
            if (!resAll.ok) throw new Error('Failed to load all users');
            const users = await resAll.json();

            renderUsers(users, currentUser);
        } catch (err) {
            console.error('Error loading users:', err);
            document.getElementById('user-list').innerHTML = '<p>Error loading users. Check network status and admin privileges.</p>';
        }
    }

    // Render users (MODIFIED: Changed comparison for 'Self' tag to use _id)
    function renderUsers(users, currentUser) {
        const container = document.getElementById('user-list');
        if (!container) return;

        if (!users.length) {
            container.innerHTML = '<p>No users found.</p>';
            return;
        }

        container.innerHTML = `
            <div class="user-row">
              <div class="user-cell"><strong>Name</strong></div>
              <div class="user-cell"><strong>Email</strong></div>
              <div class="user-cell"><strong>Role</strong></div>
              <div class="user-cell"><strong>Actions</strong></div>
            </div>
            ${users.map(u => `
              <div class="user-row">
                <div class="user-cell">${u.name}</div>
                <div class="user-cell">${u.email}</div>
                <div class="user-cell">
                  <span class="user-role user-role--${u.role}">${u.role}</span>
                </div>
                <div class="user-cell">
                  ${u._id === currentUser._id ? '<span>Self</span>' : `<button class="btn-edit" onclick="promoteUser('${u._id}', '${u.role}')">Change Role</button>`}
                </div>
              </div>
            `).join('')}
        `;
    }

    // Promote user (MODIFIED: Fully implemented PATCH call to new /api/users/:id/role route)
    async function promoteUser(id, currentRole) {
        const newRole = currentRole === 'admin' ? 'user' : 'admin';
        if (!confirm(`Are you sure you want to change this user's role to ${newRole}?`)) return;

        try {
            const res = await fetch(`${API_BASE}/users/${id}/role`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ role: newRole })
            });
            if (!res.ok) throw new Error('Failed to change role');
            alert(`✅ User role updated to ${newRole}!`);
            loadUsers(); // Refresh list
        } catch (err) {
            alert('❌ Failed to change role: ' + err.message);
        }
    }

    // Add category (MODIFIED: relies on HttpOnly cookie)
    document.getElementById('add-category-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('category-name').value;

        try {
            const res = await fetch(`${API_BASE}/products/categories`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ name })
            });
            if (!res.ok) throw new Error('Failed to add category');
            alert('✅ Category added!');
            loadCategories(); // Refresh list
            document.getElementById('add-category-form').reset();
        } catch (err) {
            alert('❌ Failed to add category: ' + err.message);
        }
    });

    // Initialize (UNMODIFIED)
    loadProducts();
    loadCategories();
    loadUsers();
  </script>
